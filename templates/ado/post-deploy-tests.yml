steps:
- bash: |
    echo "Logging in to Azure"
    az login --service-principal --username $azure_client_id --password $azure_client_secret --tenant $azure_tenant_id
    az account set -s $azure_subscription_id
  displayName: Login to Azure

- bash: terraform plan -input=false -out=tfplan
    displayName: 'Terraform: plan'
    workingDirectory: ./terraform
    env:
      ARM_SUBSCRIPTION_ID: $(azure_subscription_id)
      ARM_CLIENT_ID: $(azure_client_id)
      ARM_CLIENT_SECRET: "$(azure_client_secret)"
      ARM_TENANT_ID: $(azure_tenant_id)

- bash: terraform apply tfplan
    displayName: 'Terraform: apply'
    workingDirectory: ./terraform
    env:
      ARM_SUBSCRIPTION_ID: $(azure_subscription_id)
      ARM_CLIENT_ID: $(azure_client_id)
      ARM_CLIENT_SECRET: "$(azure_client_secret)"
      ARM_TENANT_ID: $(azure_tenant_id)

- bash: |
    /usr/local/lib/ruby/gems/2.6.0/gems/inspec-3.9.3 firepit-example -t azure:// 
  displayName: 'Test: Functional'

- bash: terraform destroy tfplan
    displayName: 'Terraform: destroy'
    workingDirectory: ./terraform
    env:
      ARM_SUBSCRIPTION_ID: $(azure_subscription_id)
      ARM_CLIENT_ID: $(azure_client_id)
      ARM_CLIENT_SECRET: "$(azure_client_secret)"
      ARM_TENANT_ID: $(azure_tenant_id)